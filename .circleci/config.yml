version: 2.1

orbs:
  vault: contentful/vault@1

executors:
  linux-node:
    resource_class: xlarge
    docker:
      - image: cimg/node:20.14.0
    environment:
      CYPRESS_INSTALL_BINARY: 0
  linux-cypress:
    resource_class: xlarge
    docker:
      - image: cypress/browsers:node-20.14.0-chrome-126.0.6478.114-1-ff-127.0.1-edge-126.0.2592.61-1
    environment:
      TZ: UTC
      CYPRESS_CACHE_FOLDER: ~/.cache/Cypress

#  macos:
#    macos:
#      xcode: 11.4

cache-key: &cache-key
  key: dependency-cache-primary-{{ arch }}-yarn-packages-{{ checksum ".nvmrc" }}-{{ checksum "yarn.lock" }}

commands:
  yarn_install:
    steps:
      - restore_cache: *cache-key
      - run: yarn install --prefer-offline --pure-lockfile
      - save_cache:
          <<: *cache-key
          paths:
            - ~/.cache/yarn
  yarn_serve:
    steps:
      - run:
          command: npx http-server dist -p 9000
          background: true
      - run: yarn wait-on -t 60000 http://localhost:9000

jobs:
  lint:
    executor: linux-node
    steps:
      - checkout
      - yarn_install
      - run: yarn lint
      - run: yarn build
      - run: yarn tsc
  unit-tests:
    parallelism: 3
    executor: linux-node
    steps:
      - checkout
      - yarn_install
      - run: yarn build
      - run: yarn test:ci
      - store_test_results:
          path: reports

  component-tests:
    parallelism: 3
    executor: linux-cypress
    steps:
      - checkout
      - yarn_install
      - run: yarn build
      - run:
          name: Run cypress component tests
          command: |
            TESTFILES=$(circleci tests glob cypress/component/**/*.ts | circleci tests split --split-by=timings --timings-type=filename | awk '{if (NR>1) printf ","; printf "%s", $0} END {if (NR>0) printf " "}')
            npx cypress run --component \
              --spec "${TESTFILES}" \
              --reporter junit \
              --reporter-options "mochaFile=./cypress/reports/component/test-results.[hash].xml" \
              --browser chrome
      - vault/get-secrets:
          template-preset: packages-read
      - run: |
          echo "//npm.pkg.github.com/:_authToken=${GITHUB_PACKAGES_READ_TOKEN}" > ~/.npmrc
          echo "@contentful:registry=https://npm.pkg.github.com" >> ~/.npmrc
      - run:
          name: Format JUnit Reports
          command: npx @contentful/circleci-orb-tools@2 fix-junit-format --path cypress/reports/component
      - store_test_results:
          path: cypress/reports/component
      - store_artifacts:
          path: cypress/videos

  prerelease:
    executor: linux-node
    steps:
      - checkout
      - yarn_install
      - vault/get-secrets:
          template-preset: semantic-release
      - vault/configure-lerna
      - run: |
          echo "//npm.pkg.github.com/:_authToken=${GITHUB_PACKAGES_WRITE_TOKEN}" > ~/.npmrc
          echo "@contentful:registry=https://npm.pkg.github.com" >> ~/.npmrc
      - run: yarn build
      - run:
          name: Create pre-release version
          command: |
            # Get PR number from Circle CI environment
            PR_NUMBER=$(echo $CIRCLE_PULL_REQUEST | grep -oE '[0-9]+$')
            SANITIZED_BRANCH=$(echo "$CIRCLE_BRANCH" | sed 's/[^a-zA-Z0-9-]/-/g' | tr '[:upper:]' '[:lower:]')
            COMMIT_HASH=$(git rev-parse --short HEAD)
            PREID="pr-${PR_NUMBER}.${SANITIZED_BRANCH}.${COMMIT_HASH}"

            # Create pre-release versions
            yarn lerna version prerelease \
              --preid ${PREID} \
              --no-git-tag-version \
              --no-push \
              --yes

            # Save PR number for later steps
            echo "export PR_NUMBER=${PR_NUMBER}" >> $BASH_ENV
      - run:
          name: Publish pre-release
          command: |
            source $BASH_ENV
            yarn lerna publish from-package \
              --no-git-tag-version \
              --no-push \
              --yes \
              --dist-tag pr-${PR_NUMBER}
      - run:
          name: Comment on PR
          command: |
            source $BASH_ENV

            # Get list of published packages
            PACKAGES=$(node -e "
              const fs = require('fs');
              const glob = require('glob');
              const packageJsons = glob.sync('packages/*/package.json');
              const packages = packageJsons.map(file => {
                const pkg = JSON.parse(fs.readFileSync(file, 'utf8'));
                return { name: pkg.name, version: pkg.version };
              }).filter(pkg => pkg.version.includes('pr-${PR_NUMBER}'));
              console.log(JSON.stringify(packages));
            ")

            # Format as markdown table
            TABLE=$(node -e "
              const packages = ${PACKAGES};
              let output = '| Package | Version |\n|---------|----------|\n';
              packages.forEach(pkg => {
                output += \`| \\\`\${pkg.name}\\\` | \\\`\${pkg.version}\\\` |\n\`;
              });
              console.log(output);
            ")

            # Create comment body
            COMMENT="## ðŸš€ Pre-release Published\n\n${TABLE}\n\n**Install:**\n\`\`\`bash\n"

            # Add example install command
            EXAMPLE_PKG=$(echo "${PACKAGES}" | node -e "
              const packages = JSON.parse(require('fs').readFileSync(0, 'utf-8'));
              if (packages.length > 0) console.log(packages[0].name);
            ")

            COMMENT="${COMMENT}yarn add ${EXAMPLE_PKG}@pr-${PR_NUMBER}\n\`\`\`"

            # Post comment using GitHub API
            curl -X POST \
              -H "Authorization: token ${GITHUB_TOKEN}" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}/issues/${PR_NUMBER}/comments" \
              -d "{\"body\":\"${COMMENT}\"}"

  release:
    executor: linux-node
    steps:
      - checkout
      - yarn_install
      - vault/get-secrets:
          template-preset: semantic-release
      - vault/configure-lerna
      - run: |
          echo "//npm.pkg.github.com/:_authToken=${GITHUB_PACKAGES_WRITE_TOKEN}" > ~/.npmrc
          echo "@contentful:registry=https://npm.pkg.github.com" >> ~/.npmrc
      - run: yarn build
      - run: yarn lerna version --no-private --conventional-commits --create-release github --yes
      - run: yarn lerna publish from-git --yes

workflows:
  version: 2
  # run on every commit
  commit:
    jobs:
      - lint:
          context: vault
      - unit-tests:
          context: vault
      - component-tests:
          context: vault
      - release:
          context: vault
          filters:
            branches:
              only: master
          requires:
            - lint
            - unit-tests

  # run when pre-release label is added to PR
  prerelease-workflow:
    when:
      and:
        - equal: [ webhook, << pipeline.trigger_source >> ]
        - equal: [ labeled, << pipeline.trigger_parameters.github.event.action >> ]
        - equal: [ pre-release, << pipeline.trigger_parameters.github.event.label.name >> ]
    jobs:
      - prerelease:
          context: vault
